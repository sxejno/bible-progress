<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">
    <title>Verse Memorization Helper - Bible Progress</title>
    <link rel="icon" type="image/png" href="favicon.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 50%, #ec4899 100%);
            background-attachment: fixed;
            min-height: 100vh;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }

        /* Enhanced glass-morphism with better contrast */
        .glass {
            background: rgba(255, 255, 255, 0.20);
            backdrop-filter: blur(16px) saturate(180%);
            border: 1.5px solid rgba(255, 255, 255, 0.3);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }

        .glass-strong {
            background: rgba(255, 255, 255, 0.25);
            backdrop-filter: blur(20px) saturate(180%);
            border: 2px solid rgba(255, 255, 255, 0.4);
            box-shadow: 0 12px 40px rgba(0, 0, 0, 0.15);
        }

        .verse-card {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .verse-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 12px 28px rgba(0, 0, 0, 0.25);
            background: rgba(255, 255, 255, 0.28);
            border-color: rgba(255, 255, 255, 0.5);
        }

        .first-letter-hint {
            font-family: 'Courier New', monospace;
            letter-spacing: 0.4em;
            font-size: 1.15em;
            font-weight: 600;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }

        .btn-mode {
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            font-weight: 600;
        }

        .btn-mode:hover:not(.active) {
            background: rgba(255, 255, 255, 0.25);
            transform: translateY(-1px);
        }

        .btn-mode.active {
            background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%);
            transform: scale(1.05);
            box-shadow: 0 4px 12px rgba(79, 70, 229, 0.4);
            border-color: rgba(255, 255, 255, 0.5);
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .fade-in {
            animation: fadeIn 0.5s ease;
        }

        .verse-text {
            font-size: 1.35rem;
            line-height: 1.9;
            font-weight: 500;
            text-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
        }

        /* Enhanced input and select styling with better contrast */
        input, textarea, select {
            background: rgba(255, 255, 255, 0.25) !important;
            backdrop-filter: blur(12px);
            border: 2px solid rgba(255, 255, 255, 0.3) !important;
            transition: all 0.2s ease;
        }

        input:focus, textarea:focus, select:focus {
            background: rgba(255, 255, 255, 0.35) !important;
            border-color: rgba(255, 255, 255, 0.6) !important;
            box-shadow: 0 0 0 3px rgba(255, 255, 255, 0.2);
            outline: none;
        }

        input::placeholder, textarea::placeholder {
            color: rgba(255, 255, 255, 0.65) !important;
            font-weight: 500;
        }

        select {
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke='white'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' stroke-width='2.5' d='M19 9l-7 7-7-7'%3E%3C/path%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 0.75rem center;
            background-size: 1.5em 1.5em;
            padding-right: 2.5rem;
            appearance: none;
            font-weight: 600;
        }

        select option {
            background-color: #4f46e5;
            color: white;
            font-weight: 500;
            padding: 8px;
        }

        /* Enhanced button styling */
        button {
            font-weight: 600;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        }

        button:hover:not(:disabled) {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        }

        button:active:not(:disabled) {
            transform: translateY(0);
        }

        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* Better text contrast */
        .text-white\/80 {
            color: rgba(255, 255, 255, 0.95) !important;
        }

        .text-white\/70 {
            color: rgba(255, 255, 255, 0.85) !important;
        }

        .text-white\/60 {
            color: rgba(255, 255, 255, 0.75) !important;
        }

        /* Enhanced verse content area */
        .verse-content-bg {
            background: rgba(0, 0, 0, 0.15);
            backdrop-filter: blur(8px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        @media (max-width: 640px) {
            .verse-text {
                font-size: 1.15rem;
            }
            .first-letter-hint {
                font-size: 1em;
                letter-spacing: 0.25em;
            }
        }

        /* Smooth scroll */
        html {
            scroll-behavior: smooth;
        }

        /* Add subtle animation to page load */
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .animate-slide-in {
            animation: slideIn 0.6s cubic-bezier(0.4, 0, 0.2, 1);
        }
    </style>
</head>
<body class="p-4">
    <!-- Header -->
    <div class="max-w-4xl mx-auto mb-8 animate-slide-in">
        <div class="glass-strong rounded-2xl p-8 shadow-2xl">
            <div class="flex items-center justify-between flex-wrap gap-4">
                <div>
                    <h1 class="text-4xl font-bold text-white mb-2 drop-shadow-lg">üìñ Verse Memorization Helper</h1>
                    <p class="text-white text-lg font-medium">Hide God's word in your heart</p>
                </div>
                <a href="index.html" class="glass px-6 py-3 rounded-xl text-white hover:bg-white/30 transition shadow-lg font-semibold">
                    ‚Üê Back to App
                </a>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <div class="max-w-4xl mx-auto space-y-6">
        <!-- Current Verse Display -->
        <div class="glass-strong rounded-2xl p-8 shadow-2xl fade-in" id="verse-display">
            <div class="mb-6 flex items-center justify-between flex-wrap gap-3">
                <h2 class="text-2xl font-bold text-white drop-shadow" id="verse-reference">Select a verse to begin</h2>
                <div class="flex gap-3">
                    <button onclick="window.prevVerse()" class="glass px-4 py-2 rounded-xl text-white hover:bg-white/30 transition shadow-lg" id="prev-btn" disabled>
                        ‚Üê Previous
                    </button>
                    <button onclick="window.nextVerse()" class="glass px-4 py-2 rounded-xl text-white hover:bg-white/30 transition shadow-lg" id="next-btn" disabled>
                        Next ‚Üí
                    </button>
                </div>
            </div>

            <div class="mb-6 verse-content-bg rounded-xl p-8 min-h-[180px] flex items-center justify-center" id="verse-content">
                <p class="text-white text-center text-lg">Select a verse from below or add your own</p>
            </div>

            <!-- Display Mode Buttons -->
            <div class="flex gap-3 mb-5 flex-wrap" id="mode-buttons" style="display: none;">
                <button onclick="window.setDisplayMode('full')" class="btn-mode glass px-6 py-3 rounded-xl text-white flex-1 min-w-[130px] shadow-lg" id="btn-full">
                    üìÑ Full Text
                </button>
                <button onclick="window.setDisplayMode('hints')" class="btn-mode glass px-6 py-3 rounded-xl text-white flex-1 min-w-[130px] shadow-lg" id="btn-hints">
                    üí° First Letters
                </button>
                <button onclick="window.setDisplayMode('hidden')" class="btn-mode glass px-6 py-3 rounded-xl text-white flex-1 min-w-[130px] shadow-lg" id="btn-hidden">
                    üôà Hidden
                </button>
            </div>

            <!-- Progress Indicator -->
            <div class="text-white text-base font-semibold" id="review-count" style="display: none;">
                Reviews: <span id="review-number" class="bg-white/20 px-3 py-1 rounded-lg ml-2">0</span>
            </div>
        </div>

        <!-- Popular Verses -->
        <div class="glass-strong rounded-2xl p-8 shadow-2xl">
            <h2 class="text-2xl font-bold text-white mb-6 drop-shadow">Popular Verses</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4" id="popular-verses">
                <!-- Populated by JavaScript -->
            </div>
        </div>

        <!-- Verse Lookup -->
        <div class="glass-strong rounded-2xl p-8 shadow-2xl">
            <h2 class="text-2xl font-bold text-white mb-6 drop-shadow">üîç Look Up & Add Verse</h2>
            <div id="bible-status" class="mb-4 text-sm text-white font-medium italic hidden">
                <!-- Status message will be inserted here -->
            </div>
            <div class="space-y-3">
                <!-- Smart Text Input -->
                <div>
                    <input
                        type="text"
                        id="smart-reference"
                        placeholder="Type reference (e.g., 'John 3:16', 'gal 3:16', 'Gen 1:1', '1 Cor 13:4-7')"
                        class="w-full px-5 py-4 rounded-xl bg-white/10 text-white placeholder-white/50 border border-white/20 focus:outline-none focus:ring-2 focus:ring-white/50 text-lg shadow-lg"
                        onkeydown="if(event.key === 'Enter') window.smartLookup()"
                    >
                    <p class="text-white text-sm mt-3 font-medium">
                        üí° Supports: Full names (John 3:16) ‚Ä¢ Abbreviations (gal 3:16) ‚Ä¢ Chapters (Psalm 23) ‚Ä¢ Ranges (John 3:16-17)
                    </p>
                </div>

                <div class="flex gap-3 flex-wrap">
                    <button
                        onclick="window.smartLookup()"
                        class="glass px-8 py-4 rounded-xl text-white hover:bg-white/30 transition flex-1 min-w-[200px] shadow-lg"
                    >
                        üîç Look Up
                    </button>
                    <button
                        onclick="window.addLookedUpVerse()"
                        class="glass px-8 py-4 rounded-xl text-white hover:bg-emerald-500/40 transition flex-1 min-w-[200px] shadow-lg"
                        id="add-lookup-btn"
                        style="display: none;"
                    >
                        ‚ûï Add to My Verses
                    </button>
                </div>

                <div id="lookup-result" class="verse-content-bg rounded-xl p-6 min-h-[120px]" style="display: none;">
                    <p class="text-white text-center text-lg">Verse will appear here</p>
                </div>

                <!-- Optional: Dropdown fallback (collapsed by default) -->
                <details class="mt-5">
                    <summary class="cursor-pointer text-white text-base hover:text-white/90 transition font-semibold">
                        Or use dropdowns (click to expand) ‚ñº
                    </summary>
                    <div class="mt-4 space-y-4">
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <select
                                id="lookup-book"
                                class="px-5 py-4 rounded-xl bg-white/10 text-white border border-white/20 focus:outline-none focus:ring-2 focus:ring-white/50 shadow-lg"
                                onchange="window.updateChapterOptions()"
                            >
                                <option value="">Select Book...</option>
                            </select>
                            <select
                                id="lookup-chapter"
                                class="px-5 py-4 rounded-xl bg-white/10 text-white border border-white/20 focus:outline-none focus:ring-2 focus:ring-white/50 shadow-lg"
                                onchange="window.updateVerseOptions()"
                                disabled
                            >
                                <option value="">Select Chapter...</option>
                            </select>
                            <select
                                id="lookup-verse"
                                class="px-5 py-4 rounded-xl bg-white/10 text-white border border-white/20 focus:outline-none focus:ring-2 focus:ring-white/50 shadow-lg"
                                disabled
                            >
                                <option value="">Select Verse...</option>
                            </select>
                        </div>
                        <button
                            onclick="window.lookupVerse()"
                            class="glass px-8 py-4 rounded-xl text-white hover:bg-white/30 transition w-full shadow-lg"
                            id="lookup-btn"
                            disabled
                        >
                            üîç Look Up from Dropdowns
                        </button>
                    </div>
                </details>
            </div>
        </div>

        <!-- Add Custom Verse (Manual Entry) -->
        <div class="glass-strong rounded-2xl p-8 shadow-2xl">
            <h2 class="text-2xl font-bold text-white mb-4 drop-shadow">‚úèÔ∏è Add Custom Verse (Manual Entry)</h2>
            <p class="text-white text-base mb-5 font-medium">For verses not in the KJV or custom references</p>
            <div class="space-y-4">
                <input
                    type="text"
                    id="custom-reference"
                    placeholder="Reference (e.g., John 3:16)"
                    class="w-full px-5 py-4 rounded-xl bg-white/10 text-white placeholder-white/50 border border-white/20 focus:outline-none focus:ring-2 focus:ring-white/50 text-lg shadow-lg"
                >
                <textarea
                    id="custom-text"
                    placeholder="Verse text (KJV)"
                    rows="4"
                    class="w-full px-5 py-4 rounded-xl bg-white/10 text-white placeholder-white/50 border border-white/20 focus:outline-none focus:ring-2 focus:ring-white/50 text-lg shadow-lg"
                ></textarea>
                <button
                    onclick="window.addCustomVerse()"
                    class="glass px-8 py-4 rounded-xl text-white hover:bg-white/30 transition w-full shadow-lg"
                >
                    ‚ûï Add to My Verses
                </button>
            </div>
        </div>

        <!-- My Custom Verses -->
        <div class="glass-strong rounded-2xl p-8 shadow-2xl" id="custom-verses-section" style="display: none;">
            <h2 class="text-2xl font-bold text-white mb-6 drop-shadow">My Verses</h2>
            <div class="space-y-3" id="custom-verses-list">
                <!-- Populated by JavaScript -->
            </div>
        </div>
    </div>

    <!-- Footer spacing -->
    <div class="h-20"></div>

    <script>
        // Security utility
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Bible data
        let bibleData = null;
        let currentLookupVerse = null; // Store the currently looked up verse

        // Book abbreviations map (supports multiple abbreviations per book)
        const BOOK_ABBREVIATIONS = {
            // Old Testament
            'genesis': ['gen', 'ge', 'gn'],
            'exodus': ['exo', 'ex', 'exod'],
            'leviticus': ['lev', 'le', 'lv'],
            'numbers': ['num', 'nu', 'nm', 'nb'],
            'deuteronomy': ['deut', 'dt', 'de'],
            'joshua': ['josh', 'jos', 'jsh'],
            'judges': ['judg', 'jdg', 'jg', 'jdgs'],
            'ruth': ['rth', 'ru'],
            '1 samuel': ['1 sam', '1sam', '1 sa', '1sa', '1 s', '1s', 'i samuel', 'i sam'],
            '2 samuel': ['2 sam', '2sam', '2 sa', '2sa', '2 s', '2s', 'ii samuel', 'ii sam'],
            '1 kings': ['1 kgs', '1kgs', '1 ki', '1ki', '1 k', '1k', 'i kings', 'i kgs'],
            '2 kings': ['2 kgs', '2kgs', '2 ki', '2ki', '2 k', '2k', 'ii kings', 'ii kgs'],
            '1 chronicles': ['1 chr', '1chr', '1 ch', '1ch', 'i chronicles', 'i chr'],
            '2 chronicles': ['2 chr', '2chr', '2 ch', '2ch', 'ii chronicles', 'ii chr'],
            'ezra': ['ezr', 'ez'],
            'nehemiah': ['neh', 'ne'],
            'esther': ['est', 'es'],
            'job': ['jb'],
            'psalms': ['psalm', 'ps', 'psa', 'psm', 'pss'],
            'proverbs': ['prov', 'pro', 'pr', 'prv'],
            'ecclesiastes': ['eccl', 'ecc', 'ec', 'eccles'],
            'song of solomon': ['song', 'sos', 'ss', 'so', 'canticles', 'canticle of canticles'],
            'isaiah': ['isa', 'is'],
            'jeremiah': ['jer', 'je', 'jr'],
            'lamentations': ['lam', 'la'],
            'ezekiel': ['ezek', 'eze', 'ezk'],
            'daniel': ['dan', 'da', 'dn'],
            'hosea': ['hos', 'ho'],
            'joel': ['joe', 'jl'],
            'amos': ['amo', 'am'],
            'obadiah': ['obad', 'ob'],
            'jonah': ['jnh', 'jon'],
            'micah': ['mic', 'mc'],
            'nahum': ['nah', 'na'],
            'habakkuk': ['hab', 'hb'],
            'zephaniah': ['zeph', 'zep', 'zp'],
            'haggai': ['hag', 'hg'],
            'zechariah': ['zech', 'zec', 'zc'],
            'malachi': ['mal', 'ml'],
            // New Testament
            'matthew': ['matt', 'mat', 'mt'],
            'mark': ['mar', 'mrk', 'mk', 'mr'],
            'luke': ['luk', 'lk'],
            'john': ['joh', 'jhn', 'jn'],
            'acts': ['act', 'ac'],
            'romans': ['rom', 'ro', 'rm'],
            '1 corinthians': ['1 cor', '1cor', '1 co', '1co', 'i corinthians', 'i cor'],
            '2 corinthians': ['2 cor', '2cor', '2 co', '2co', 'ii corinthians', 'ii cor'],
            'galatians': ['gal', 'ga'],
            'ephesians': ['eph', 'ephes'],
            'philippians': ['phil', 'php', 'pp'],
            'colossians': ['col', 'co'],
            '1 thessalonians': ['1 thess', '1thess', '1 thes', '1thes', '1 th', '1th', 'i thessalonians', 'i thess'],
            '2 thessalonians': ['2 thess', '2thess', '2 thes', '2thes', '2 th', '2th', 'ii thessalonians', 'ii thess'],
            '1 timothy': ['1 tim', '1tim', '1 ti', '1ti', 'i timothy', 'i tim'],
            '2 timothy': ['2 tim', '2tim', '2 ti', '2ti', 'ii timothy', 'ii tim'],
            'titus': ['tit', 'ti'],
            'philemon': ['philem', 'phm', 'pm'],
            'hebrews': ['heb', 'he'],
            'james': ['jas', 'jm'],
            '1 peter': ['1 pet', '1pet', '1 pe', '1pe', '1 pt', '1pt', '1 p', '1p', 'i peter', 'i pet'],
            '2 peter': ['2 pet', '2pet', '2 pe', '2pe', '2 pt', '2pt', '2 p', '2p', 'ii peter', 'ii pet'],
            '1 john': ['1 joh', '1joh', '1 jhn', '1jhn', '1 jn', '1jn', '1 j', '1j', 'i john', 'i joh'],
            '2 john': ['2 joh', '2joh', '2 jhn', '2jhn', '2 jn', '2jn', '2 j', '2j', 'ii john', 'ii joh'],
            '3 john': ['3 joh', '3joh', '3 jhn', '3jhn', '3 jn', '3jn', '3 j', '3j', 'iii john', 'iii joh'],
            'jude': ['jud', 'jd'],
            'revelation': ['rev', 're', 'rv', 'revelations']
        };

        // Build reverse lookup map (abbreviation -> full name)
        const ABBREV_TO_BOOK = {};
        Object.keys(BOOK_ABBREVIATIONS).forEach(fullName => {
            // Add full name as key
            ABBREV_TO_BOOK[fullName.toLowerCase()] = fullName;
            // Add all abbreviations as keys
            BOOK_ABBREVIATIONS[fullName].forEach(abbrev => {
                ABBREV_TO_BOOK[abbrev.toLowerCase()] = fullName;
            });
        });

        // Popular KJV verses
        const POPULAR_VERSES = [
            {
                reference: "John 3:16",
                text: "For God so loved the world, that he gave his only begotten Son, that whosoever believeth in him should not perish, but have everlasting life."
            },
            {
                reference: "Philippians 4:13",
                text: "I can do all things through Christ which strengtheneth me."
            },
            {
                reference: "Jeremiah 29:11",
                text: "For I know the thoughts that I think toward you, saith the Lord, thoughts of peace, and not of evil, to give you an expected end."
            },
            {
                reference: "Psalm 23:1",
                text: "The Lord is my shepherd; I shall not want."
            },
            {
                reference: "Romans 8:28",
                text: "And we know that all things work together for good to them that love God, to them who are the called according to his purpose."
            },
            {
                reference: "Proverbs 3:5-6",
                text: "Trust in the Lord with all thine heart; and lean not unto thine own understanding. In all thy ways acknowledge him, and he shall direct thy paths."
            },
            {
                reference: "Isaiah 41:10",
                text: "Fear thou not; for I am with thee: be not dismayed; for I am thy God: I will strengthen thee; yea, I will help thee; yea, I will uphold thee with the right hand of my righteousness."
            },
            {
                reference: "Matthew 6:33",
                text: "But seek ye first the kingdom of God, and his righteousness; and all these things shall be added unto you."
            },
            {
                reference: "Psalm 119:11",
                text: "Thy word have I hid in mine heart, that I might not sin against thee."
            },
            {
                reference: "Romans 12:2",
                text: "And be not conformed to this world: but be ye transformed by the renewing of your mind, that ye may prove what is that good, and acceptable, and perfect, will of God."
            },
            {
                reference: "2 Timothy 1:7",
                text: "For God hath not given us the spirit of fear; but of power, and of love, and of a sound mind."
            },
            {
                reference: "Joshua 1:9",
                text: "Have not I commanded thee? Be strong and of a good courage; be not afraid, neither be thou dismayed: for the Lord thy God is with thee whithersoever thou goest."
            }
        ];

        // State
        let currentVerseIndex = -1;
        let currentDisplayMode = 'full';
        let customVerses = [];
        let verseProgress = {}; // Tracks review counts

        // Initialize
        async function init() {
            loadData();
            renderPopularVerses();
            renderCustomVerses();
            await loadBibleData();
        }

        // Load Bible data from JSON file
        async function loadBibleData() {
            try {
                const response = await fetch('kjv_bible.json');
                if (!response.ok) {
                    throw new Error('Failed to load Bible data');
                }
                bibleData = await response.json();
                populateBookDropdown();

                // Show Bible status
                const statusDiv = document.getElementById('bible-status');
                if (statusDiv && bibleData) {
                    const bookCount = bibleData.length;
                    statusDiv.textContent = `üìö ${bookCount} books loaded (KJV)`;
                    statusDiv.classList.remove('hidden');
                }
            } catch (e) {
                console.error('Error loading Bible data:', e);
                // Show error message to user
                const statusDiv = document.getElementById('bible-status');
                if (statusDiv) {
                    statusDiv.className = 'mb-4 text-base text-red-200 font-bold';
                    statusDiv.textContent = '‚ö†Ô∏è Error loading Bible data. Verse lookup is unavailable.';
                    statusDiv.classList.remove('hidden');
                }
            }
        }

        // Parse verse reference from text input
        function parseReference(input) {
            if (!input || !input.trim()) {
                return { error: 'Please enter a reference' };
            }

            // Clean input
            input = input.trim().toLowerCase();

            // Pattern: "book chapter:verse" or "book chapter:verse-verse" or "book chapter"
            // Examples: "john 3:16", "gal 3:16-17", "psalm 23", "1 cor 13:4"

            // Try to match: (book name) (chapter) optional(:verse or :verse-verse)
            const patterns = [
                // With verse range: "john 3:16-17"
                /^(.+?)\s+(\d+):(\d+)-(\d+)$/,
                // With single verse: "john 3:16"
                /^(.+?)\s+(\d+):(\d+)$/,
                // Chapter only: "psalm 23"
                /^(.+?)\s+(\d+)$/
            ];

            let match = null;
            let patternType = null;

            for (let i = 0; i < patterns.length; i++) {
                match = input.match(patterns[i]);
                if (match) {
                    patternType = i;
                    break;
                }
            }

            if (!match) {
                return { error: 'Invalid format. Try: "John 3:16" or "gal 3:16" or "Psalm 23"' };
            }

            // Extract parts
            const bookInput = match[1].trim();
            const chapter = parseInt(match[2]);
            const verseStart = match[3] ? parseInt(match[3]) : null;
            const verseEnd = match[4] ? parseInt(match[4]) : null;

            // Find book in Bible data
            const normalizedBookName = ABBREV_TO_BOOK[bookInput];
            if (!normalizedBookName) {
                return { error: `Book "${bookInput}" not found. Check spelling or try an abbreviation.` };
            }

            // Find book in bibleData
            const bookIndex = bibleData.findIndex(b => b.book.toLowerCase() === normalizedBookName.toLowerCase());
            if (bookIndex === -1) {
                return { error: `Book "${normalizedBookName}" not found in database.` };
            }

            const book = bibleData[bookIndex];

            // Validate chapter
            if (chapter < 1 || chapter > book.chapters.length) {
                return { error: `${book.book} only has ${book.chapters.length} chapters.` };
            }

            const chapterData = book.chapters[chapter - 1];

            // If chapter only, return all verses
            if (!verseStart) {
                return {
                    book: book.book,
                    bookIndex,
                    chapter: chapter,
                    chapterIndex: chapter - 1,
                    verses: 'all',
                    verseCount: chapterData.verses.length
                };
            }

            // Validate verses
            if (verseStart < 1 || verseStart > chapterData.verses.length) {
                return { error: `${book.book} ${chapter} only has ${chapterData.verses.length} verses.` };
            }

            if (verseEnd && (verseEnd < verseStart || verseEnd > chapterData.verses.length)) {
                return { error: `Invalid verse range. ${book.book} ${chapter} has ${chapterData.verses.length} verses.` };
            }

            return {
                book: book.book,
                bookIndex,
                chapter: chapter,
                chapterIndex: chapter - 1,
                verseStart,
                verseEnd: verseEnd || verseStart
            };
        }

        // Smart lookup from text input
        window.smartLookup = function() {
            const input = document.getElementById('smart-reference');
            const resultDiv = document.getElementById('lookup-result');
            const addBtn = document.getElementById('add-lookup-btn');

            if (!bibleData) {
                alert('Bible data is still loading. Please wait a moment.');
                return;
            }

            const parsed = parseReference(input.value);

            if (parsed.error) {
                resultDiv.style.display = 'block';
                resultDiv.innerHTML = `
                    <div class="text-red-200 text-center">
                        <div class="font-bold text-lg mb-3">‚ö†Ô∏è Error</div>
                        <div class="text-base font-medium">${escapeHtml(parsed.error)}</div>
                    </div>
                `;
                addBtn.style.display = 'none';
                currentLookupVerse = null;
                return;
            }

            // Get verse text
            const book = bibleData[parsed.bookIndex];
            const chapter = book.chapters[parsed.chapterIndex];
            let verseText = '';
            let reference = '';

            if (parsed.verses === 'all') {
                // Get all verses in chapter
                verseText = chapter.verses.map(v => v.text).join(' ');
                reference = `${parsed.book} ${parsed.chapter}`;
            } else if (parsed.verseStart === parsed.verseEnd) {
                // Single verse
                const verse = chapter.verses[parsed.verseStart - 1];
                verseText = verse.text;
                reference = `${parsed.book} ${parsed.chapter}:${parsed.verseStart}`;
            } else {
                // Verse range
                const verses = chapter.verses.slice(parsed.verseStart - 1, parsed.verseEnd);
                verseText = verses.map(v => v.text).join(' ');
                reference = `${parsed.book} ${parsed.chapter}:${parsed.verseStart}-${parsed.verseEnd}`;
            }

            // Store for adding later
            currentLookupVerse = {
                reference: reference,
                text: verseText
            };

            // Display result
            resultDiv.style.display = 'block';
            resultDiv.innerHTML = `
                <div class="text-white font-bold text-lg mb-3">${escapeHtml(reference)}</div>
                <div class="text-white leading-relaxed font-medium">${escapeHtml(verseText)}</div>
            `;

            // Show add button
            addBtn.style.display = 'block';

            // Clear input for next lookup
            // input.value = ''; // Commented out - keep the reference visible
        };

        // Populate book dropdown
        function populateBookDropdown() {
            if (!bibleData) return;

            const bookSelect = document.getElementById('lookup-book');
            bibleData.forEach((book, index) => {
                const option = document.createElement('option');
                option.value = index;
                option.textContent = book.book;
                bookSelect.appendChild(option);
            });
        }

        // Update chapter options when book is selected
        window.updateChapterOptions = function() {
            const bookSelect = document.getElementById('lookup-book');
            const chapterSelect = document.getElementById('lookup-chapter');
            const verseSelect = document.getElementById('lookup-verse');
            const lookupBtn = document.getElementById('lookup-btn');

            // Reset chapter and verse dropdowns
            chapterSelect.innerHTML = '<option value="">Select Chapter...</option>';
            verseSelect.innerHTML = '<option value="">Select Verse...</option>';
            chapterSelect.disabled = true;
            verseSelect.disabled = true;
            lookupBtn.disabled = true;

            const bookIndex = bookSelect.value;
            if (bookIndex === '') return;

            const book = bibleData[bookIndex];
            book.chapters.forEach((chapter, index) => {
                const option = document.createElement('option');
                option.value = index;
                option.textContent = chapter.chapter;
                chapterSelect.appendChild(option);
            });

            chapterSelect.disabled = false;
        };

        // Update verse options when chapter is selected
        window.updateVerseOptions = function() {
            const bookSelect = document.getElementById('lookup-book');
            const chapterSelect = document.getElementById('lookup-chapter');
            const verseSelect = document.getElementById('lookup-verse');
            const lookupBtn = document.getElementById('lookup-btn');

            // Reset verse dropdown
            verseSelect.innerHTML = '<option value="">Select Verse...</option>';
            verseSelect.disabled = true;
            lookupBtn.disabled = true;

            const bookIndex = bookSelect.value;
            const chapterIndex = chapterSelect.value;
            if (bookIndex === '' || chapterIndex === '') return;

            const chapter = bibleData[bookIndex].chapters[chapterIndex];

            // Add "All verses" option
            const allOption = document.createElement('option');
            allOption.value = 'all';
            allOption.textContent = `All verses (1-${chapter.verses.length})`;
            verseSelect.appendChild(allOption);

            // Add individual verses
            chapter.verses.forEach((verse, index) => {
                const option = document.createElement('option');
                option.value = index;
                option.textContent = verse.verse;
                verseSelect.appendChild(option);
            });

            verseSelect.disabled = false;
            lookupBtn.disabled = false;
        };

        // Look up verse
        window.lookupVerse = function() {
            const bookSelect = document.getElementById('lookup-book');
            const chapterSelect = document.getElementById('lookup-chapter');
            const verseSelect = document.getElementById('lookup-verse');
            const resultDiv = document.getElementById('lookup-result');
            const addBtn = document.getElementById('add-lookup-btn');

            const bookIndex = bookSelect.value;
            const chapterIndex = chapterSelect.value;
            const verseIndex = verseSelect.value;

            if (bookIndex === '' || chapterIndex === '' || verseIndex === '') {
                alert('Please select book, chapter, and verse');
                return;
            }

            const book = bibleData[bookIndex];
            const chapter = book.chapters[chapterIndex];

            let verseText = '';
            let reference = '';

            if (verseIndex === 'all') {
                // Get all verses
                verseText = chapter.verses.map(v => v.text).join(' ');
                reference = `${book.book} ${chapter.chapter}`;
            } else {
                // Get single verse
                const verse = chapter.verses[verseIndex];
                verseText = verse.text;
                reference = `${book.book} ${chapter.chapter}:${verse.verse}`;
            }

            // Store for adding later
            currentLookupVerse = {
                reference: reference,
                text: verseText
            };

            // Display result
            resultDiv.style.display = 'block';
            resultDiv.innerHTML = `
                <div class="text-white font-bold text-lg mb-3">${escapeHtml(reference)}</div>
                <div class="text-white leading-relaxed font-medium">${escapeHtml(verseText)}</div>
            `;

            // Show add button
            addBtn.style.display = 'block';
        };

        // Add looked up verse to custom verses
        window.addLookedUpVerse = function() {
            if (!currentLookupVerse) {
                alert('Please look up a verse first');
                return;
            }

            customVerses.push(currentLookupVerse);
            saveData();
            renderCustomVerses();

            // Select the newly added verse
            window.selectVerse(customVerses.length - 1, 'custom');

            // Clear lookup
            currentLookupVerse = null;
            document.getElementById('lookup-result').style.display = 'none';
            document.getElementById('add-lookup-btn').style.display = 'none';

            // Show success feedback
            const addBtn = document.getElementById('add-lookup-btn');
            const originalText = addBtn.textContent;
            addBtn.textContent = '‚úì Added!';
            addBtn.classList.add('bg-emerald-500/50');
            setTimeout(() => {
                addBtn.textContent = originalText;
                addBtn.classList.remove('bg-emerald-500/50');
            }, 2000);
        };

        // Load data from localStorage
        function loadData() {
            try {
                const saved = localStorage.getItem('bible_memorization_data');
                if (saved) {
                    const data = JSON.parse(saved);
                    customVerses = data.customVerses || [];
                    verseProgress = data.verseProgress || {};
                }
            } catch (e) {
                console.error('Error loading data:', e);
            }
        }

        // Save data to localStorage
        function saveData() {
            try {
                localStorage.setItem('bible_memorization_data', JSON.stringify({
                    customVerses,
                    verseProgress
                }));
            } catch (e) {
                console.error('Error saving data:', e);
            }
        }

        // Render popular verses
        function renderPopularVerses() {
            const container = document.getElementById('popular-verses');
            container.innerHTML = POPULAR_VERSES.map((verse, index) => `
                <button
                    onclick="window.selectVerse(${index}, 'popular')"
                    class="verse-card glass px-5 py-4 rounded-xl text-left text-white hover:bg-white/30 shadow-lg"
                >
                    <div class="font-bold text-lg mb-1">${escapeHtml(verse.reference)}</div>
                    <div class="text-sm text-white mt-2 truncate font-medium">${escapeHtml(verse.text.substring(0, 50))}...</div>
                </button>
            `).join('');
        }

        // Render custom verses
        function renderCustomVerses() {
            const section = document.getElementById('custom-verses-section');
            const container = document.getElementById('custom-verses-list');

            if (customVerses.length === 0) {
                section.style.display = 'none';
                return;
            }

            section.style.display = 'block';
            container.innerHTML = customVerses.map((verse, index) => `
                <div class="flex items-center gap-3">
                    <button
                        onclick="window.selectVerse(${index}, 'custom')"
                        class="verse-card glass px-5 py-4 rounded-xl text-left text-white hover:bg-white/30 flex-1 shadow-lg"
                    >
                        <div class="font-bold text-lg mb-1">${escapeHtml(verse.reference)}</div>
                        <div class="text-sm text-white mt-2 truncate font-medium">${escapeHtml(verse.text.substring(0, 50))}...</div>
                    </button>
                    <button
                        onclick="window.deleteCustomVerse(${index})"
                        class="glass px-4 py-4 rounded-xl text-white hover:bg-red-500/60 transition shadow-lg text-xl"
                        title="Delete verse"
                    >
                        üóëÔ∏è
                    </button>
                </div>
            `).join('');
        }

        // Select a verse
        window.selectVerse = function(index, type) {
            currentVerseIndex = index;
            const verse = type === 'popular' ? POPULAR_VERSES[index] : customVerses[index];
            const verseKey = `${type}_${index}`;

            // Update review count
            if (!verseProgress[verseKey]) {
                verseProgress[verseKey] = 0;
            }
            verseProgress[verseKey]++;
            saveData();

            // Update display
            document.getElementById('verse-reference').textContent = verse.reference;
            document.getElementById('mode-buttons').style.display = 'flex';
            document.getElementById('review-count').style.display = 'block';
            document.getElementById('review-number').textContent = verseProgress[verseKey];

            // Store current type for navigation (must be set before setDisplayMode)
            window.currentVerseType = type;

            // Enable navigation for popular verses only
            if (type === 'popular') {
                document.getElementById('prev-btn').disabled = index === 0;
                document.getElementById('next-btn').disabled = index === POPULAR_VERSES.length - 1;
                document.getElementById('prev-btn').classList.toggle('opacity-50', index === 0);
                document.getElementById('next-btn').classList.toggle('opacity-50', index === POPULAR_VERSES.length - 1);
            } else {
                document.getElementById('prev-btn').disabled = true;
                document.getElementById('next-btn').disabled = true;
                document.getElementById('prev-btn').classList.add('opacity-50');
                document.getElementById('next-btn').classList.add('opacity-50');
            }

            setDisplayMode('full');
        };

        // Navigation
        window.prevVerse = function() {
            if (window.currentVerseType === 'popular' && currentVerseIndex > 0) {
                window.selectVerse(currentVerseIndex - 1, 'popular');
            }
        };

        window.nextVerse = function() {
            if (window.currentVerseType === 'popular' && currentVerseIndex < POPULAR_VERSES.length - 1) {
                window.selectVerse(currentVerseIndex + 1, 'popular');
            }
        };

        // Set display mode
        window.setDisplayMode = function(mode) {
            currentDisplayMode = mode;
            const verse = window.currentVerseType === 'popular' ? POPULAR_VERSES[currentVerseIndex] : customVerses[currentVerseIndex];
            const container = document.getElementById('verse-content');

            // Update button states
            document.querySelectorAll('.btn-mode').forEach(btn => btn.classList.remove('active'));
            document.getElementById(`btn-${mode}`).classList.add('active');

            if (mode === 'full') {
                container.innerHTML = `<p class="text-white verse-text text-center">${escapeHtml(verse.text)}</p>`;
            } else if (mode === 'hints') {
                const hints = verse.text.split(' ').map(word => {
                    // Keep punctuation at the end
                    const match = word.match(/^(\W*)(.*?)(\W*)$/);
                    if (match) {
                        const [, prefix, letters, suffix] = match;
                        return prefix + (letters ? letters[0] : '') + suffix;
                    }
                    return word[0] || '';
                }).join(' ');
                container.innerHTML = `<p class="text-white first-letter-hint text-center">${escapeHtml(hints)}</p>`;
            } else if (mode === 'hidden') {
                container.innerHTML = `
                    <div class="text-center">
                        <p class="text-white text-lg mb-4 font-medium">Try to recite the verse from memory</p>
                        <button onclick="window.setDisplayMode('hints')" class="glass px-6 py-3 rounded-xl text-white hover:bg-white/30 transition shadow-lg font-semibold">
                            üí° Show Hints
                        </button>
                    </div>
                `;
            }
        };

        // Add custom verse
        window.addCustomVerse = function() {
            const reference = document.getElementById('custom-reference').value.trim();
            const text = document.getElementById('custom-text').value.trim();

            if (!reference || !text) {
                alert('Please enter both a reference and verse text');
                return;
            }

            customVerses.push({ reference, text });
            saveData();

            // Clear inputs
            document.getElementById('custom-reference').value = '';
            document.getElementById('custom-text').value = '';

            // Re-render
            renderCustomVerses();

            // Select the newly added verse
            window.selectVerse(customVerses.length - 1, 'custom');
        };

        // Delete custom verse
        window.deleteCustomVerse = function(index) {
            if (confirm('Delete this verse from your list?')) {
                customVerses.splice(index, 1);
                saveData();
                renderCustomVerses();

                // Clear display if this was the active verse
                if (window.currentVerseType === 'custom' && currentVerseIndex === index) {
                    document.getElementById('verse-reference').textContent = 'Select a verse to begin';
                    document.getElementById('verse-content').innerHTML = '<p class="text-white text-center text-lg">Select a verse from below or add your own</p>';
                    document.getElementById('mode-buttons').style.display = 'none';
                    document.getElementById('review-count').style.display = 'none';
                }
            }
        };

        // Keyboard shortcuts
        document.addEventListener('keydown', (e) => {
            if (currentVerseIndex === -1) return;

            if (e.key === '1') setDisplayMode('full');
            if (e.key === '2') setDisplayMode('hints');
            if (e.key === '3') setDisplayMode('hidden');
            if (e.key === 'ArrowLeft' && window.currentVerseType === 'popular') window.prevVerse();
            if (e.key === 'ArrowRight' && window.currentVerseType === 'popular') window.nextVerse();
        });

        // Initialize on load
        init();
    </script>
</body>
</html>
